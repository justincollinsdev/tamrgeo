

# Tamrgeo

This is the tamrgeo project, a wrapper to encapsulate and simplify geospatial operations.

### Resources
GeoJson is a standard format to represent geospatial objects.
  
#### Some geojson resources:

The spec:  
[http://geojson.org/](http://geojson.org/)

A useful tutorial:  
[https://macwright.org/2015/03/23/geojson-second-bite](https://macwright.org/2015/03/23/geojson-second-bite)

A visualizer:  
[http://geojson.io/](http://geojson.io/)  Just paste your geojson in the right hand panel and you can see it.

Useful sources of data that might be interesting:  
[http://www.gadm.org/country](http://www.gadm.org/country)  
[http://www.naturalearthdata.com/downloads/](http://www.naturalearthdata.com/downloads/)  
[http://census.ire.org/data/bulkdata.html](http://census.ire.org/data/bulkdata.html)  


Online resource to simplify and convert various formats, including to/from geojson.  If you have a very complex or large geojson file or shape file you can use this site to 'simplify' it to make it more appropriate for your specific use.  Very detailed geojson of large features like the United States, or Texas can be very very large (10s or 100s of MB) and for most purposes are not any better than vastly simplified versions.  For many uses, you can use mapshaper to simplify all the way down to single percentages and have just as usable results.  
[https://mapshaper.org/](https://mapshaper.org/)

Additional tools to sanity check results, including calculating distances between points.  
[https://www.movable-type.co.uk/scripts/latlong.html](https://www.movable-type.co.uk/scripts/latlong.html)

### Sample data
We'll use some data repeatedly for our tests and samples, it's worth familiarizing ourselves with it.

---
This is human generated geometries for two nearly identical nearby buildings with the centroids of the geometries marked:


  
```
{"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[[-76.94055497646332,38.89279897704893],[-76.94063544273376,38.89269877110009],[-76.9405147433281,38.892650755699506],[-76.94052278995514,38.89264031756465],[-76.94045573472977,38.892613178406855],[-76.94044768810272,38.892621528918056],[-76.94033235311508,38.8925756010943],[-76.94027066230774,38.892682070094885],[-76.94036453962326,38.89271755972628],[-76.94035649299622,38.892730085474284],[-76.94038063287734,38.89274261122009],[-76.9403886795044,38.89273426072314],[-76.94041550159454,38.892740523595954],[-76.94041013717651,38.89274887409217],[-76.94044500589371,38.89276557508168],[-76.94045037031174,38.89275722458742],[-76.94055497646332,38.89279897704893]]]}},{"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[[-76.94049060344696,38.89290335809527],[-76.94038063287734,38.8928595180745],[-76.94039136171341,38.8928469923493],[-76.94036185741425,38.892834466621885],[-76.94035112857819,38.89284281710708],[-76.94032698869705,38.892834466621885],[-76.9403350353241,38.892815678026636],[-76.94030553102493,38.89280315229372],[-76.94030016660689,38.892813590404636],[-76.94020360708237,38.892782276067265],[-76.94012850522995,38.892884569518266],[-76.94023579359055,38.89292840952359],[-76.94023042917252,38.89293884761611],[-76.94030553102493,38.892963899031884],[-76.94030821323395,38.89295554856093],[-76.9404262304306,38.89300356375547],[-76.94049060344696,38.89290335809527]]]}},{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-76.94044908447397,38.89268827342768]}},{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-76.94030974454634,38.8928914572184]}},{"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[-76.940449,38.892688],[-76.94031,38.892891]]}}]}
```


<img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/identicalbuildingswithcentroids.png?raw=true" alt="2 identical buildings" height="250"/>



---
This is two different geometries for the same building, one generated by a human, the other by Bing ML linked to at the top of this README:


  
```
{"type":"FeatureCollection","features":[{"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[[-76.9399031996727,38.8924566061401],[-76.93984016776085,38.89242842309543],[-76.93984284996986,38.89242007256153],[-76.93978652358055,38.892400240039564],[-76.93967387080193,38.89256203150434],[-76.93950220942497,38.8924941835156],[-76.93949550390244,38.89236057497904],[-76.93943917751312,38.89236057497904],[-76.93943917751312,38.892352224437175],[-76.93936541676521,38.89235118061938],[-76.9393627345562,38.892558900060116],[-76.93973153829575,38.89270712160122],[-76.9399031996727,38.8924566061401]]]}}]}
```

<img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedHuman.png?raw=true" alt="2 identical buildings" height="250"/>

  
```
{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-76.939331,38.892333],[-76.939328,38.892561],[-76.939719,38.892689],[-76.939863,38.892424],[-76.939742,38.892384],[-76.939658,38.89254],[-76.939638,38.892539],[-76.939466,38.892483],[-76.939467,38.892334],[-76.939331,38.892333]]]},"properties":{}}
```

<img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedML.png?raw=true" alt="U Shaped Human" height="250"/>



### Operations
#### Read and Write GeoJson  
Read a Shape from a geojson String:

```java
    TamrGeoUtils gu = new TamrGeoUtils();
    String geoString = readFile("{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-76.94044908447397,38.89268827342768]}}");
    Shape s = gu.fromGeoJson(geoString);
```

Write a shape to a geojson String

```java
    TamrGeoUtils gu = new TamrGeoUtils();
    String geoString = readFile("{"type":"Feature","properties":{},"geometry":{"type":"Point","coordinates":[-76.94044908447397,38.89268827342768]}}");
    Shape s = gu.fromGeoJson(geoString);
    String geojson = gu.toGeoJson(s);
```
See GeoUtilsTest.java for more examples, and examples of reading geojson from a file to a String.  


  

  
#### Object Centroid

```java
    TamrGeoUtils gu = new TamrGeoUtils();
    String bldg1JsonString = readFile("uShapedMLGeneratedBuilding.json");
    Shape bldg1CentroidShape = gu.fromGeoJson(bldg1JsonString);
    Point bldg1Centroid = gu.getCentroid(bldg1CentroidShape);
    String centroidJson = gu.toGeoJson(bldg1Centroid);
```
The result of this is 

  
```
{"type":"Point","coordinates":[-76.939568,38.892514]}
```

<img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedBlgCentroid.png?raw=true" alt="U Shaped Bldg Centroid" height="250"/>


  
#### Point in Polygon
To extend on the example above, to show that the point is contained inside the polygon of the U shaped building use   

```
    gu.polygonContainsPoint(bldg1CentroidShape, bldg1Centroid)
```

Note that it is possible for the centroid of a polygon to fall outside the polygon.  To show this, a distorted version of the U shaped building can be used:

<img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/centroidoutsidepolygon.png?raw=true" alt="Centroid outside polygon" height="250"/>

    
#### Point to Point distance (can also be used to determine line length)
Distance is calculated using [Haversine](https://en.wikipedia.org/wiki/Haversine_formula).  If you are visually looking at two points on a projected map be aware that the visual difference between the two points gets more and more distorted the nearer you get to the poles (depending on the projection).

```
    TamrGeoUtils gu = new TamrGeoUtils();
    String bldg1JsonString = readFile("identicalBuilding1.json");
    Shape bldg1Shape = gu.fromGeoJson(bldg1JsonString);
    Point bldg1Centroid = gu.getCentroid(bldg1Shape);
    String bldg2JsonString = readFile("identicalBuilding2.json");
    Shape bldg2Shape = gu.fromGeoJson(bldg2JsonString);
    Point bldg2Centroid = gu.getCentroid(bldg2CentroidShape);
    double centroidDifference = gu.calculateDistance(bldg1Centroid, bldg2Centroid);
```
centroidDifference is the distance *in meters* between the centroids of the two buildings.
  

#### Area calculations
Calculating the areas of geometries on a globe is more complex than just the geometry of calculating are on a flat plane.  This calculation assumes a spherical earth, in fact the earth is ellipsoidal, which will cause this estimate to be accurate to approximately .3%.  By definition if the Shape passed in is a Point or Line this method will return 0.0.  Only Polygons have Area.  Returns the area of the specified Shape in *square meters*.

```
    TamrGeoUtils gu = new TamrGeoUtils();
    String geoString = readFile("uShapedHumanGeneratedBuilding.json");
    Shape s = gu.fromGeoJson(geoString);
    double area = gu.calculateArea(s);
```

#### Object Repositioning
Reposition the source object so that the centroid is in the same location as the specified destination object.  This can be used to compare two objects irrespective of location.  For example, the ML and Human generated versions of the U shaped example building. 

```
    TamrGeoUtils gu = new TamrGeoUtils();
    String bldg1JsonString = readFile("uShapedHumanGeneratedBuilding.json");
    Shape bldg1Shape = gu.fromGeoJson(bldg1JsonString);
    String bldg2JsonString = readFile("uShapedMLGeneratedBuilding.json");
    Shape bldg2Shape = gu.fromGeoJson(bldg2JsonString);
    Shape relocatedShape = gu.relocate(bldg1Shape, bldg2Shape);
```

| Original Location | Destination Location | Result |
|--|--|--|
| <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedHuman.png?raw=true" alt="Human" height="250"/>| <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedML.png?raw=true" alt="ML" height="250"/> | <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/relocatedHumanUshaped.png?raw=true" alt="relocated" height="250"/> |

Note that the result maintains the shape of the Source Shape but has moved East so that the centroid of the Source is now in the same location as the centroid of the Destination Shape.


  
#### Intersection Shape
Calculate the Shape of the area of intersection between the two specified polygons.

| Poly 1 (Human) | Poly 2 (ML) | Result |
|--|--|--|
| <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedHuman.png?raw=true" alt="Human" height="250"/>| <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedML.png?raw=true" alt="ML" height="250"/> | <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedintersection.png?raw=true" alt="Intersection" height="250"/> |

The dark shaded portion of the result image is the Shape that will be returned by this operation.


  
#### Intersection Area
Returns the area, in square meters, of the intersection of the two specified Shapes.  By definition Lines and Points have no area, so the intersection of a Point and anything, or a Line and anything will result in an area of 0.0.
    
#### Hausdorff Similarity
Measures the degree of similarity between two Shapes using the [Hausdorff](https://en.wikipedia.org/wiki/Hausdorff_distance) distance metric.  The measure is normalized to lie in the range [0, 1].  Higher measures indicate a greater degree of similarity.  The measure is computed by computing the Hausdorff distance  between the input geometries, and then normalizing this by dividing it by the diagonal distance across the envelope of the combined geometries.


  
#### Combining intersection, relocation, area and Hausdorff
Relocation can be used in combination with the intersection, area and Hausdorff operations to establish similarity between shapes without regard for their location.  Be careful with this, depending on your use case it can be deceptive to try to establish that two shapes are the 'same' real world object once you've moved them around.

Continuing with the U shaped building from above

```
    TamrGeoUtils gu = new TamrGeoUtils();
    String bldg1JsonString = readFile("uShapedHumanGeneratedBuilding.json");
    Shape bldg1Shape = gu.fromGeoJson(bldg1JsonString);
    String bldg2JsonString = readFile("uShapedMLGeneratedBuilding.json");
    Shape bldg2Shape = gu.fromGeoJson(bldg2JsonString);
		
    bldg1Shape = gu.relocate(bldg1Shape, bldg2Shape);
```

| Relocated Human | Original ML | Result |
|--|--|--|
| <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/relocatedHumanUshaped.png?raw=true" alt="Human" height="250"/>| <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedML.png?raw=true" alt="ML" height="250"/> | <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/relocatedintersection.png?raw=true" alt="Intersection" height="250"/> |


To compare the resulting shapes we can view only the overlapping areas
| Intersection Before reposition | Intersection After reposition |
|--|--|--|
| <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/ushapedintersection.png?raw=true" alt="Human" height="250"/>| <img src="https://github.com/justincollinsdev/tamrgeo/blob/master/img/relocatedintersectionshape.png?raw=true" alt="ML" height="250"/> | 

